<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        // IMMEDIATE THEME & LANGUAGE APPLICATION
        // This script runs synchronously and applies the theme and language
        // before the browser paints the body, preventing FOUC (Flash Of Unstyled Content).
        (function() {
            const isFirstVisit = !localStorage.getItem('hasVisited');

            if (isFirstVisit) {
                localStorage.setItem('language', 'en'); // Default to English on first visit
                localStorage.setItem('theme', 'light'); // Default to light theme on first visit
                localStorage.setItem('hasVisited', 'true');
            }

            const storedTheme = localStorage.getItem('theme') || 'light';
            const storedLanguage = localStorage.getItem('language') || 'en';

            document.documentElement.setAttribute('data-theme', storedTheme);
            document.documentElement.lang = storedLanguage;
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="siteTitle">Marius Jomphe - Photography</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Theme (Default) */
            --bg-color: #f4f7f6;
            --text-color: #1a1a1a;
            --header-bg-color: #ffffff;
            --nav-link-color: #333333;
            --nav-link-hover-color: #000000;

            --placeholder-bg-color: #ffffff; /* White for light theme */

            --button-bg-color: #e0e0e0;
            --button-text-color: #1a1a1a;
            --button-hover-bg-color: #c7c7c7;
            --image-viewer-bg: rgba(0, 0, 0, 0.95); /* Increased opacity for darker overlay */
            --image-viewer-nav-color: #ffffff;
            --image-viewer-nav-hover-bg: rgba(255, 255, 255, 0.2);
            --loader-color: #007bff;
            --announcement-bg: rgba(240, 240, 240, 0.95);
            --announcement-text: #1a1a1a;
            --announcement-border: #cccccc;
            --announcement-button-bg: #1a1a1a; /* Dark gray/black for light theme button background */
            --announcement-button-text: #ffffff; /* White text for light theme button */

            /* Base font size for scaling */
            --base-font-size: 16px;
            --base-spacing: 1rem; /* 16px */
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #f4f7f6;
            --header-bg-color: #2c2c2c;
            --nav-link-color: #e0e0e0;
            --nav-link-hover-color: #ffffff;
            
            --placeholder-bg-color: #000000; /* Black for dark theme */
            --button-bg-color: #444444;
            --button-text-color: #f4f7f6;
            --button-hover-bg-color: #5a5a5a;
            --image-viewer-bg: rgba(0, 0, 0, 0.95); /* Increased opacity for darker overlay */
            --image-viewer-nav-color: #e0e0e0;
            --loader-color: #58a6ff;
            --announcement-bg: rgba(40, 40, 40, 0.95);
            --announcement-text: #f4f7f6;
            --announcement-border: #555555;
            --announcement-button-bg: #e0e0e0; /* Light gray/white for dark theme button background */
            --announcement-button-text: #1a1a1a; /* Black text for dark theme button */
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: var(--base-font-size);
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden; /* Prevent horizontal scrollbars from appearing briefly during transitions */
        }

        h1, h2, h3 {
            font-family: 'Montserrat', sans-serif;
            margin-bottom: calc(var(--base-spacing) * 0.75);
        }

        img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        a {
            color: var(--nav-link-hover-color);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        a:hover {
            text-decoration: underline;
        }

        .container {
            width: 90%;
            max-width: 1800px; /* Increased max-width for larger screens */
            margin: 0 auto;
            padding: var(--base-spacing);
        }

        /* Header & Navigation */
        .site-header {
            background-color: var(--header-bg-color);
            padding: var(--base-spacing) 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: background-color 0.3s ease;
        }

        .site-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
        }

        .logo {
            font-size: clamp(1.5rem, 2.5vw, 2.2rem); /* Responsive font size */
            font-weight: 700;
            color: var(--text-color);
        }

        .main-nav ul {
            list-style: none;
            display: flex;
            gap: calc(var(--base-spacing) * 1.5);
        }

        .main-nav a {
            font-weight: 500;
            font-size: clamp(0.9rem, 1.5vw, 1.1rem);
            color: var(--nav-link-color);
            padding: calc(var(--base-spacing) * 0.5) 0;
            position: relative;
            text-transform: uppercase; /* Add this line to make text uppercase */
        }
        .main-nav a.active {
            color: var(--text-color); /* use theme's main text color */
            font-weight: 700;
        }

        .main-nav a.active::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            display: block;
            bottom: 0px; /* Add this to position it at the bottom */
            left: 0;
            background: var(--text-color); /* underline in text color */
        }

        .main-nav a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            display: block;
            bottom: 0px; /* Add this to position it at the bottom */
            right: 0;
            background: var(--nav-link-hover-color);
            transition: width 0.3s ease;
            -webkit-transition: width 0.3s ease;
        }

        .main-nav a:hover::after {
            width: 100%;
            left: 0;
            background: var(--nav-link-hover-color);
        }
        .main-nav a:hover {
            color: var(--nav-link-hover-color);
            text-decoration: none;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: calc(var(--base-spacing) * 1.5); /* Increase spacing to match nav link gap */
        }

        .control-button {
            background: none;
            border: none;
            font-weight: 500;
            font-size: clamp(0.9rem, 1.5vw, 1.1rem);
            color: var(--nav-link-color);
            padding: calc(var(--base-spacing) * 0.5) 0;
            position: relative;
            cursor: pointer;
            transition: color 0.2s ease;
            text-transform: uppercase;
            line-height: inherit; /* Ensure consistent line height with nav links */

            /* Additions for stable width and alignment */
            display: inline-block;
            min-width: auto;
        }

        .control-button::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            display: block;
            bottom: 0px; /* Add this to position it at the bottom */
            right: 0;
            background: var(--nav-link-hover-color);
            transition: width 0.3s ease;
        }

        .control-button:hover {
            color: var(--nav-link-hover-color);
        }

        .control-button:hover::after {
            width: 100%;
            left: 0;
            background: var(--nav-link-hover-color);
        }

        .control-button:active::after,
        .control-button:focus::after {
            width: 0; /* Ensure no underline on click (active) or focus */
        }

        [data-theme="dark"] .control-button {
            color: var(--nav-link-color);
        }

        /* Image Gallery */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--base-spacing);
            padding: calc(var(--base-spacing) * 2) 0;
        }

        .gallery-item {
            position: relative;
            overflow: hidden;
            aspect-ratio: 1 / 1;
            /* Placeholder background for while image loads */
            background-color: var(--placeholder-bg-color); /* Use a CSS variable */
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease; /* Add background-color to transition */

            /* Performance improvements for lazy rendering off-screen items */
            content-visibility: auto;
            contain-intrinsic-size: 250px 250px; /* Corresponds to minmax(250px,...) */
        }
        .gallery-item:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            opacity: 0; /* Initially hidden for fade-in */
            /* Adjust these values for a smoother fade */
            transition: opacity 0.2s ease-in-out;
        }
        .gallery-item img.loaded { /* Class to trigger fade-in */
            opacity: 1;
        }


        /* Fullscreen Image Viewer */
        .image-viewer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--image-viewer-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }

        .image-viewer-overlay.active {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
        }

        .image-viewer-content {
            width: 100vw;
            height: 100vh;
            padding: 5vh 5vw; 
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .image-viewer-content img {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            border-radius: 3px;
            opacity: 0; /* Start transparent, JS will handle fade-in */
            /* transition: opacity 4s ease-in-out; */ /* JS will manage this dynamically */
        }

        .viewer-close-button,
        .viewer-nav-button {
            position: fixed;
            background: transparent;
            color: var(--image-viewer-nav-color);
            border: none;
            font-size: clamp(1.8rem, 3vw, 2.5rem);
            cursor: pointer;
            padding: calc(var(--base-spacing) * 0.5);
            transition: background-color 0.2s ease, color 0.2s ease;
            z-index: 2001; 
            border-radius: 50%;
            width: clamp(40px, 6vw, 60px);
            height: clamp(40px, 6vw, 60px);
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .viewer-close-button:hover,
        .viewer-nav-button:hover {
            background-color: var(--image-viewer-nav-hover-bg);
        }

        .viewer-close-button {
            top: calc(var(--base-spacing) * 1.5);
            right: calc(var(--base-spacing) * 1.5);
        }

        .viewer-nav-button.prev {
            left: calc(var(--base-spacing) * 1.5);
            top: 50%;
            transform: translateY(-50%);
        }

        .viewer-nav-button.next {
            right: calc(var(--base-spacing) * 1.5);
            top: 50%;
            transform: translateY(-50%);
        }

        /* Footer */
        .site-footer {
            text-align: center; /* Center the text within the footer */
            padding: calc(var(--base-spacing) * 1) 0;
            margin-top: calc(var(--base-spacing) * 2);
            border-top: 1px solid var(--button-bg-color);
            font-size: clamp(0.8rem, 1.2vw, 0.9rem);
        }

        .site-footer .container {
            display: flex;
            flex-direction: column; /* Stack signature and text */
            align-items: center; /* Center items horizontally */
            gap: calc(var(--base-spacing) * 0.5); /* Space between signature and text */
        }

        .artist-signature {
            /* No specific alignment needed here as the container centers it */
            margin-top: calc(var(--base-spacing) * 0.5); /* Smaller space */
            margin-bottom: calc(var(--base-spacing) * 0.5);
        }

        .artist-signature img {
            max-width: 300px; /* Increased size - adjust as needed */
            height: auto;
            opacity: 0.4; /* 40% opacity */
            transition: opacity 0.3s ease;
            display: none; /* Hide both by default */
        }

        /* Show light signature for light theme */
        html[data-theme="light"] .artist-signature .signature-light {
            display: block;
        }

        /* Show dark signature for dark theme */
        html[data-theme="dark"] .artist-signature .signature-dark {
            display: block;
        }

        .artist-signature a {
            text-decoration: none; /* Remove underline from link */
            display: inline-block; /* Ensures the link wraps the image appropriately */
        }

        .artist-signature a:hover {
            text-decoration: none; /* Ensure no underline on hover */
        }

        /* Announcement Overlay */
        #announcementOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Hidden by default, shown by JS */
            justify-content: center;
            align-items: center;
            z-index: 3000;
            padding: var(--base-spacing);
        }

        .announcement-content {
            background-color: var(--announcement-bg);
            color: var(--announcement-text);
            padding: calc(var(--base-spacing) * 2);
            border-radius: 8px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 90%;
            text-align: center;
            border: 1px solid var(--announcement-border);
        }
        .announcement-content h2 {
            margin-top: 0;
            color: var(--text-color); 
        }
        .announcement-content p {
            margin-bottom: calc(var(--base-spacing) * 1.5);
            line-height: 1.7;
        }
        #closeAnnouncement {
            /* This rule already uses the CSS variables, so it will adapt automatically */
            background-color: var(--announcement-button-bg);
            color: var(--announcement-button-text);
            border: none;
            padding: calc(var(--base-spacing) * 0.7) calc(var(--base-spacing) * 1.5);
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(0.9rem, 1.3vw, 1rem);
            transition: background-color 0.3s ease, color 0.3s ease; /* Added color to transition */
        }

        #closeAnnouncement:hover {
            /* You might want a subtle hover effect */
            opacity: 0.85; /* Keep the opacity change */
        }


        /* Responsive Adjustments */

        /* For smaller mobiles - header controls might stack */
        @media (max-width: 480px) {
            .site-header .container {
                flex-direction: column;
                gap: calc(var(--base-spacing) * 0.5);
            }
            .main-nav ul {
                gap: var(--base-spacing);
                justify-content: center;
                flex-wrap: wrap;
            }
            .controls {
                margin-top: calc(var(--base-spacing) * 0.5);
            }
        }

        /* Tablets and small desktops */
        @media (min-width: 768px) {
            .image-gallery {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: calc(var(--base-spacing) * 1.5);
            }
            .gallery-item {
                contain-intrinsic-size: 300px 300px; 
            }
        }

        /* Larger desktops */
        @media (min-width: 1200px) {
            :root {
                --base-font-size: 17px; 
            }
            .image-gallery {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
            .gallery-item {
                contain-intrinsic-size: 350px 350px; 
            }
        }

        /* 4K Displays */
        @media (min-width: 2000px) {
            :root {
                --base-font-size: 20px; 
            }
            .container {
                max-width: 2400px; 
            }
            .image-gallery {
                grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
                gap: calc(var(--base-spacing) * 1.8);
            }
            .gallery-item {
                contain-intrinsic-size: 400px 400px; 
            }
            .logo {
                font-size: 2.8rem;
            }
            .main-nav a {
                font-size: 1.4rem;
            }
            .control-button {
                padding: calc(var(--base-spacing) * 0.7) calc(var(--base-spacing) * 1.2);
                font-size: 1.2rem;
            }
            .viewer-close-button,
            .viewer-nav-button {
                font-size: 3rem;
                width: 70px;
                height: 70px;
            }
        }

    </style>
</head>
<body>

    <div id="announcementOverlay">
        <div class="announcement-content">
            <h2 data-lang-key="announcementTitle">Welcome!</h2>
            <p data-lang-key="announcementText">This is a special announcement. Check out the latest updates or ongoing promotions here. This message appears once per session.</p>
            <button id="closeAnnouncement" data-lang-key="announcementClose">Close</button>
        </div>
    </div>

    <header class="site-header">
        <div class="container">
            <div class="logo" data-lang-key="siteTitle">Marius Jomphe</div>
            
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html"  class="active" data-lang-key="navImages">Images</a></li>
                    <li><a href="about.html" data-lang-key="navAbout">About</a></li>
                    <li><a href="contact.html" data-lang-key="navContact">Contact</a></li>
                </ul>
            </nav>
            
            <div class="controls">
                <button id="themeToggle" class="control-button" aria-label="Toggle theme">
                     <span data-lang-key="themeToggleDark">Dark Mode</span>
                    <span data-lang-key="themeToggleLight" style="display:none;">Light Mode</span>
                </button>
                
                <button id="languageToggle" class="control-button" aria-label="Toggle language">
                    🌐 English
                </button>
                
            </div>
        </div>
    </header>

    <main>
        <section class="image-gallery-section">
            <div class="container">
                <div class="image-gallery" id="imageGallery">
                    </div>
            </div>
        </section>
    </main>

    <div class="image-viewer-overlay" id="imageViewerOverlay">
        <button class="viewer-close-button" id="viewerCloseButton" aria-label="Close image viewer">&times;</button>
        <button class="viewer-nav-button prev" id="viewerPrevButton" aria-label="Previous image">&lt;</button>
        <div class="image-viewer-content">
            <img src="" alt="Enlarged view" id="fullscreenImage">
        </div>
        <button class="viewer-nav-button next" id="viewerNextButton" aria-label="Next image">&gt;</button>
    </div>

    <footer class="site-footer">
        <div class="container">
            <div class="artist-signature">
                <a href="contact.html" aria-label="Contact the artist - signature link">
                    <img src="images/signaturelt.png" alt="Artist Signature (Light Theme)" class="signature-light" id="signatureLight">
                    <img src="images/signaturedt.png" alt="Artist Signature (Dark Theme)" class="signature-dark" id="signatureDark">
                </a>
            </div>
            <p>&copy; <span id="currentYear"></span> - <span data-lang-key="footerRights">All rights reserved.</span></p>
        </div>
    </footer>

    <script>
        // Highlight active nav link based on current URL
        document.querySelectorAll('.main-nav a').forEach(link => {
            const currentPath = window.location.pathname;
            const linkPath = link.getAttribute('href');
            if (currentPath.endsWith(linkPath) || ( (currentPath === '/' || currentPath.endsWith('/index.html') ) && linkPath === 'index.html')) {
                link.classList.add('active');
            } else {
                link.classList.remove('active'); 
            }
        });


        document.addEventListener('DOMContentLoaded', () => {
            
            // --- CONFIGURATION ---
            const imageFilenames = [
                'Site-1.webp', 'Site-2.webp', 'Site-3.webp', 'Site-4.webp', 'Site-5.webp',
                'Site-6.webp', 'Site-7.webp', 'Site-8.webp', 'Site-9.webp', 'Site-10.webp',
                'Site-11.webp', 'Site-12.webp', 'Site-13.webp', 'Site-14.webp', 'Site-15.webp',
                'Site-16.webp', 'Site-17.webp', 'Site-18.webp', 'Site-19.webp', 'Site-20.webp',
                'Site-21.webp', 'Site-22.webp', 'Site-23.webp', 'Site-24.webp', 'Site-25.webp',
                'Site-26.webp', 'Site-27.webp', 'Site-28.webp', 'Site-29.webp', 'Site-30.webp',
                'Site-31.webp', 'Site-32.webp', 'Site-33.webp', 'Site-34.webp', 'Site-35.webp',
                'Site-36.webp', 'Site-37.webp', 'Site-38.webp', 'Site-39.webp', 'Site-40.webp',
                'Site-41.webp', 'Site-42.webp', 'Site-43.webp', 'Site-44.webp', 'Site-45.webp',
                'Site-46.webp', 'Site-47.webp', 'Site-48.webp', 'Site-49.webp', 'Site-50.webp',
                'Site-51.webp', 'Site-52.webp', 'Site-53.webp', 'Site-54.webp', 'Site-55.webp',
                'Site-56.webp', 'Site-57.webp', 'Site-58.webp', 'Site-59.webp', 'Site-60.webp',
                'Site-61.webp', 'Site-62.webp', 'Site-63.webp', 'Site-64.webp', 'Site-65.webp',
                'Site-66.webp', 'Site-67.webp', 'Site-68.webp', 'Site-69.webp', 'Site-70.webp',
                'Site-71.webp', 'Site-72.webp', 'Site-73.webp', 'Site-74.webp', 'Site-75.webp',
                'Site-76.webp', 'Site-77.webp', 'Site-78.webp', 'Site-79.webp', 'Site-80.webp',
                'Site-81.webp', 'Site-82.webp', 'Site-83.webp', 'Site-84.webp', 'Site-85.webp',
                'Site-86.webp', 'Site-87.webp', 'Site-88.webp', 'Site-89.webp', 'Site-90.webp',
                'Site-91.webp', 'Site-92.webp', 'Site-93.webp', 'Site-94.webp', 'Site-95.webp'
            ];

            const imagePath = 'images/'; 

            // --- TRANSLATIONS ---
            const translations = {
                en: {
                    siteTitle: "Marius Jomphe - Photography",
                    navImages: "GALLERY",
                    navAbout: "ABOUT",
                    navContact: "CONTACT",
                    themeToggleDark: "🌓 DARK THEME",
                    themeToggleLight: "🌓 LIGHT THEME",
                    languageToggleText: "🌐 FRANÇAIS", 
                    footerRights: "All rights reserved.",
                    announcementTitle: "Welcome!",
                    announcementText: "This is a special announcement. Check out the latest updates or ongoing promotions here. This message appears once per session.",
                    announcementClose: "Close",
                },
                fr: {
                    siteTitle: "Marius Jomphe - Photographie",
                    navImages: "GALERIE",
                    navAbout: "À PROPOS",
                    navContact: "CONTACT",
                    themeToggleDark: "🌓 THÈME SOMBRE",
                    themeToggleLight: "🌓 THÈME CLAIR",
                    languageToggleText: "🌐 ENGLISH", 
                    footerRights: "Tous droits réservés.",
                    announcementTitle: "Bienvenue !",
                    announcementText: "Ceci est une annonce spéciale. Consultez les dernières mises à jour ou promotions en cours ici. Ce message apparaît une fois par session.",
                    announcementClose: "Fermer",
                }
            };

            // --- ELEMENTS ---
            const themeToggleButton = document.getElementById('themeToggle');
            const languageToggleButton = document.getElementById('languageToggle');
            const galleryContainer = document.getElementById('imageGallery');
            const imageViewerOverlay = document.getElementById('imageViewerOverlay');
            const fullscreenImage = document.getElementById('fullscreenImage');
            const viewerCloseButton = document.getElementById('viewerCloseButton');
            const viewerPrevButton = document.getElementById('viewerPrevButton');
            const viewerNextButton = document.getElementById('viewerNextButton');
            const currentYearSpan = document.getElementById('currentYear');
            const announcementOverlay = document.getElementById('announcementOverlay');
            const closeAnnouncementButton = document.getElementById('closeAnnouncement');

            let currentImageIndex = 0;
            let currentLanguage = localStorage.getItem('language') || 'en'; 
            let currentTheme = localStorage.getItem('theme') || 'light'; 

            // --- GALLERY & IMAGE FUNCTIONS ---
            const createImageOnIntersection = (entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const galleryItemDiv = entry.target;
                        const fullResFilename = galleryItemDiv.dataset.fullresFilename;
                        const currentImagePath = galleryItemDiv.dataset.imagePath; 

                        if (!fullResFilename || galleryItemDiv.querySelector('img')) {
                            observer.unobserve(galleryItemDiv);
                            return;
                        }

                        const img = document.createElement('img');
                        const namePart = fullResFilename.substring(0, fullResFilename.lastIndexOf('.'));
                        const extension = fullResFilename.substring(fullResFilename.lastIndexOf('.'));
                        const thumbnailFilename = `${namePart}-thumb${extension}`;
                        
                        img.src = currentImagePath + thumbnailFilename;
                        const altNamePart = fullResFilename.substring(0, fullResFilename.lastIndexOf('.'));
                        img.alt = `Thumbnail of ${altNamePart.replace(/[\W_]+/g," ")} - Marius Jomphe`;
                        img.loading = 'lazy';
                        img.decoding = 'async';
                        img.addEventListener('load', () => img.classList.add('loaded'));
                        if (img.complete) img.classList.add('loaded'); 

                        galleryItemDiv.appendChild(img);
                        observer.unobserve(galleryItemDiv); 
                    }
                });
            };

            const imageObserver = new IntersectionObserver(createImageOnIntersection, {
                rootMargin: '0px 0px 200px 0px', 
                threshold: 0.01 
            });

            function populateGallery() {
                if (!galleryContainer) return;
                galleryContainer.innerHTML = ''; 
                imageFilenames.forEach((fullResFilename, index) => {
                    const item = document.createElement('div');
                    item.className = 'gallery-item';
                    item.dataset.index = index; 
                    item.dataset.fullresFilename = fullResFilename; 
                    item.dataset.imagePath = imagePath; 
                    galleryContainer.appendChild(item);
                    imageObserver.observe(item); 
                });
            }

            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                if (themeToggleButton) { 
                    const toggleDarkText = themeToggleButton.querySelector('[data-lang-key="themeToggleDark"]');
                    const toggleLightText = themeToggleButton.querySelector('[data-lang-key="themeToggleLight"]');
                    if (toggleDarkText && toggleLightText) { 
                        if (theme === 'dark') {
                            toggleDarkText.style.display = 'none';
                            toggleLightText.style.display = 'inline';
                        } else {
                            toggleDarkText.style.display = 'inline';
                            toggleLightText.style.display = 'none';
                        }
                    }
                }
            }

            function applyLanguage(lang) {
                currentLanguage = lang;
                localStorage.setItem('language', lang);
                document.documentElement.lang = lang;
                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.dataset.langKey;
                    if (translations[lang] && translations[lang][key]) {
                        if (el.id === 'themeToggle') {
                            const darkTextSpan = el.querySelector('[data-lang-key="themeToggleDark"]');
                            const lightTextSpan = el.querySelector('[data-lang-key="themeToggleLight"]');
                            if (darkTextSpan) darkTextSpan.textContent = translations[lang]['themeToggleDark'];
                            if (lightTextSpan) lightTextSpan.textContent = translations[lang]['themeToggleLight'];
                        } else {
                             el.textContent = translations[lang][key];
                        }
                    }
                });
                if (languageToggleButton) { 
                    languageToggleButton.textContent = translations[lang]?.languageToggleText || (lang === 'en' ? '🌐 FRANÇAIS' : '🌐 ENGLISH');
                }
                applyTheme(currentTheme); 
            }

            if (currentYearSpan) {
                currentYearSpan.textContent = new Date().getFullYear();
            }

            // --- EVENT LISTENERS ---
            if (themeToggleButton) {
                themeToggleButton.addEventListener('click', () => {
                    currentTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                    applyLanguage(currentLanguage); 
                });
            }

            if (languageToggleButton) {
                languageToggleButton.addEventListener('click', () => {
                    const newLang = currentLanguage === 'en' ? 'fr' : 'en';
                    applyLanguage(newLang);
                });
            }

            if (galleryContainer) {
                galleryContainer.addEventListener('click', (e) => {
                    const item = e.target.closest('.gallery-item');
                    if (item) {
                        currentImageIndex = parseInt(item.dataset.index);
                        openImageViewer(currentImageIndex);
                    }
                });
            }

            if (viewerCloseButton) viewerCloseButton.addEventListener('click', closeImageViewer);
            if (viewerPrevButton) viewerPrevButton.addEventListener('click', showPrevImage);
            if (viewerNextButton) viewerNextButton.addEventListener('click', showNextImage);
            
            if (imageViewerOverlay) {
                imageViewerOverlay.addEventListener('click', (e) => {
                    if (e.target === imageViewerOverlay) closeImageViewer();
                });
            }

            document.addEventListener('keydown', (e) => {
                if (imageViewerOverlay && imageViewerOverlay.classList.contains('active')) {
                    if (e.key === 'Escape') closeImageViewer();
                    if (e.key === 'ArrowLeft') showPrevImage();
                    if (e.key === 'ArrowRight') showNextImage();
                }
            });
            
            if (announcementOverlay && closeAnnouncementButton) {
                if (!sessionStorage.getItem('announcementShown')) {
                    announcementOverlay.style.display = 'flex';
                }
                closeAnnouncementButton.addEventListener('click', () => {
                    announcementOverlay.style.display = 'none';
                    sessionStorage.setItem('announcementShown', 'true');
                });
            }

            // --- IMAGE VIEWER FUNCTIONS ---
            function loadAndShowImageInViewer(newIndex, isOpeningViewer = false) {
                if (!imageViewerOverlay || !fullscreenImage || imageFilenames.length === 0) return;

                currentImageIndex = newIndex;

                if (isOpeningViewer) {
                    imageViewerOverlay.classList.add('active');
                    if (document.body) document.body.style.overflow = 'hidden';
                }

                // 1. Instantly make the current image (or placeholder) transparent WITHOUT transition
                fullscreenImage.style.transition = 'none'; // Remove any existing transition to set initial state
                fullscreenImage.style.opacity = 0;
                fullscreenImage.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // Tiny transparent GIF placeholder
                fullscreenImage.alt = ""; // Clear alt for placeholder

                const imageUrl = imagePath + imageFilenames[currentImageIndex];
                const altText = `Enlarged view of ${imageFilenames[currentImageIndex].replace(/[\W_]+/g," ")} - Marius Jomphe`;

                const tempImg = new Image(); // Preload the new image
                
                tempImg.onload = () => {
                    // 2. New image is loaded. Update the src and alt of the fullscreen image.
                    // At this point, fullscreenImage is still opacity 0 and has no transition.
                    fullscreenImage.src = imageUrl;
                    fullscreenImage.alt = altText;

                    // 3. Use requestAnimationFrame. This ensures that the browser has a chance to process
                    // the new src and the opacity:0 state before the transition to opacity:1 starts.
                    requestAnimationFrame(() => {
                        // 4. Now, apply the desired transition and change opacity to 1 to trigger the fade-in.
                        fullscreenImage.style.transition = 'opacity 1s ease-in-out';
                        fullscreenImage.style.opacity = 1;
                    });
                    updateNavButtons();
                };

                tempImg.onerror = () => {
                    console.error("Error loading image:", imageUrl);
                    fullscreenImage.alt = "Error loading image"; 
                    if (isOpeningViewer) {
                        setTimeout(closeImageViewer, 1500); // Close viewer if initial image fails
                    }
                    updateNavButtons(); 
                };
                
                // Start loading the new image
                tempImg.src = imageUrl;
            }

            function openImageViewer(index) {
                loadAndShowImageInViewer(index, true);
            }

            function closeImageViewer() {
                if (!imageViewerOverlay) return;
                imageViewerOverlay.classList.remove('active');
                if (document.body) document.body.style.overflow = '';
                // Optional: Reset image details to free up memory or prevent FOUC on next open
                // fullscreenImage.style.transition = 'none'; 
                // fullscreenImage.style.opacity = 0;
                // fullscreenImage.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
            }

            function showPrevImage() {
                if (imageFilenames.length === 0) return;
                const newIndex = (currentImageIndex - 1 + imageFilenames.length) % imageFilenames.length;
                loadAndShowImageInViewer(newIndex);
            }

            function showNextImage() {
                if (imageFilenames.length === 0) return;
                const newIndex = (currentImageIndex + 1) % imageFilenames.length;
                loadAndShowImageInViewer(newIndex);
            }

            function updateNavButtons() {
                if (!viewerPrevButton || !viewerNextButton || imageFilenames.length <= 1) {
                    if(viewerPrevButton) viewerPrevButton.style.display = 'none';
                    if(viewerNextButton) viewerNextButton.style.display = 'none';
                    return;
                }
                if(viewerPrevButton) viewerPrevButton.style.display = 'block';
                if(viewerNextButton) viewerNextButton.style.display = 'block';
            }

            // --- INITIAL LOAD ---
            populateGallery();
            applyLanguage(currentLanguage); 
            updateNavButtons(); 

        });
    </script>
</body>
</html>
